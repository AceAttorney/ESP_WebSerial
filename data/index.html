<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esp Web Serial Server</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <script src="./jquery.min.js"></script>
    <script src="./bootstrap.min.js"></script>
    <style type="text/css">
        #serial-out {
            width: 100%;
            overflow: auto;
            word-break: break-all; 
            resize: none;
        }
        #serial-input {
            width: 100%;
            overflow: auto;
            word-break: break-all; 
            resize: none;
        }
        .btn{
            width: 24%;
        }
    </style>
    

</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <textarea class="form-control" id="serial-out" rows="30" readonly="readonly" ></textarea>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <input type="text" class="form-control" placeholder="输入命令" id="serial-input" rows="1" onkeydown="hotkey()">
            </div>
        </div>
        <div class="row">
            <div class="col-12 md-0" style="text-align:center">
                <button onclick="sendmsg('\x0A')"title="Cancel" class="btn btn-success" type="button">Linefeed</button>
                <button onclick="sendmsg('\x0D')"title="Cancel" class="btn btn-success" type="button">Enter</button>
                <button onclick="sendmsg('\x20')"title="Cancel" class="btn btn-success" type="button">Space</button>
                <button onclick="sendmsg('\x03')"title="Cancel" class="btn btn-success" type="button">Stop</button>

            </div>
        </div>
    </div>
    <script>
        //ws  = new WebSocket('ws://192.168.20.145:81');
        ws = new WebSocket('ws://'+document.location.hostname+':8088')
        var msgout = document.getElementById('serial-out');
        var msgin = document.getElementById('serial-input');
        if ('WebSocket' in window)
            console.log('Pass');
        else
            alert('游览器不支持');
        ws.onopen = function(){
            console.log('连接建立成功');
        }
        ws.onerror = function(err){
            console.log(err.data);
        }
        
        ws.onmessage = function(serialmsg){
            
            msgout.innerHTML+=serialmsg.data;
            msgout.scrollTop = msgout.scrollHeight;

        }

        ws.onclose = function(){
            
            msgout.innerHTML+="&#10;"+"Lost Connect............"+"&#10;"
        }
        //不能发送空消息，否则ESP会崩溃。
        function sendmsg(key){
            ws.send(key);
            console.log(key);
        }
        function hotkey(){
            if (event.keyCode == 13 && msgin.value != ""){
                ws.send(msgin.value+'\r\n');
                msgin.value = '';
                msgout.scrollTop = msgout.scrollHeight;
            }
        }

        window.onbeforeunload = function(){
            ws.close();
            console.log('连接已关闭');
        }

        window.onclose =function(){
            ws.close();
            console.log('连接已关闭');
        }
    </script>
</body>
</html>